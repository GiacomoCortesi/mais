openapi: 3.0.3
info:
  title: AI Music Subtitles - OpenAPI 3.0
  description: |-
    AI Music to Subtitles API documentation
  contact:
    name: Giacomo Cortesi
    url: https://giacomocortesi.github.io/hugo-gc
    email: giacomo.cortesi1993@gmail.com
  license:
    name: Apache 2.0
    url: http://www.apache.org/licenses/LICENSE-2.0.html
  version: 1.0.0
servers:
- url: http://{username}:{port}
  description: API server
  variables:
    username:
      default: localhost
    port:
      enum:
        - '8080'
        - '443'
      default: '8080'

tags:
  - name: job
    description: Music AI subtitles generator jobs
  - name: transcription
    description: Transcription CRUD operations
  - name: file
    description: Audio/Video files CRUD operations
paths:
  /job:
    post:
      tags:
        - job
      summary: Create a new subtitles generation job
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JobRequest'
      responses:
        '200':
          description: Subtitles generation job successfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Bad Request"
                detail: "'test' is not of type 'boolean' - 'config.speaker_detection'"
                status: 400
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"              
    get:
      tags:
        - job
      summary: Get all job details
      responses:
        '200':
          description: Jobs details successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/JobResponse'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                    
  /job/{id}:
    get:
      tags:
        - job
      summary: Get job details
      parameters:
       - name: id
         in: path
         required: true
         schema:
          type: string
      responses:
        '200':
          description: Job details successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/JobResponse'
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested job ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                  
  /transcription:
    post:
      tags:
        - transcription
      summary: Creates a new transcription
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                schema:
                  $ref: '#/components/schemas/TranscriptionRequest'

      responses:
        '200':
          description: Transcription succesfully created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Bad Request"
                detail: "Bad Request"
                status: 400
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                     
    get:
      tags:
        - transcription
      summary: Fetch all transcriptions
      responses:
        '200':
          description: Transcriptions successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                    $ref: '#/components/schemas/TranscriptionResponse'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                           
  /transcription/{id}:
    get:
      tags:
        - transcription
      summary: Retrieves a specific transcription
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Transcription successfully retrieved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                  
    delete:
      tags:
        - transcription
      summary: Deletes a specific transcription
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Transcription successfully deleted
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"            
    patch:
      tags:
        - transcription
      summary: Edit a specific transcription
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                data:
                  $ref: '#/components/schemas/TranscriptionData'
      responses:
        '204':
          description: Transcriptions successfully edited
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"          
  /transcription/{id}/fix:
    post:
      tags:
        - transcription
      summary: Attempts to fix all subtitles text with AI
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Transcription fix action succesfull
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"          
  /transcription/{id}/fit:
    post:
      tags:
        - transcription
      summary: Fit start and end of each subtitles segment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Transcription fit action succesfull
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"            
  /transcription/{id}/clear:
    post:
      tags:
        - transcription
      summary: Restores initial transcription
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '204':
          description: Transcription successfully cleared
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"          
  /transcription/{id}/export:
    get:
      tags:
        - transcription
      summary: Export transcription in several subtitle formats
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
        - name: "format"
          in: "query"
          description: "The format to export the transcription in"
          required: false
          schema:
            type: "string"
            enum: [srt, stt]
      responses:
        '200':
          description: Successful export
          content:
            application/octet-stream:
              schema:
                type: string
                format: binary
        '400':
          description: Unsupported format
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "BadRequest"
                detail: "Unsupported export format"
                status: 400
                type: "about:blank"
        '404':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "NotFound"
                detail: "The requested transcription ID was not found on the server"
                status: 404
                type: "about:blank"
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                         
  /file:
    post:
      tags:
        - file
      summary: Uploads a video or audio file
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                file:
                  type: string
                  format: binary
      responses:
        '200':
          description: File successfully uploaded
        '400':
          description: Bad Request
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "BadRequest"
                detail: "Filename missing'"
                status: 500
                type: "about:blank"           
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"          
    delete:
      tags:
        - file
      parameters:
        - name: "filename"
          in: "query"
          description: "Filename of the audio or video file to be deleted, if no filename, all uploaded files are deleted"
          required: false
          schema:
            type: "string"
      summary: Delete uploaded file(s)
      responses:
        '204':
          description: File successfully deleted
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"        
    get:
      tags:
        - file
      summary: Retrieves the list of uploaded files
      responses:
        '200':
          description: Files successfully retrieved
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FileResponse'
        '500':
          description: Internal Server Error
          content:
            application/problem+json:
              schema:
                $ref: '#/components/schemas/ErrorModel'
              example:
                title: "Internal Server Error"
                detail: "Unexpected error'"
                status: 500
                type: "about:blank"                        

components:
  schemas:
    JobInfo:
      type: object
      properties:
        config:
          $ref: '#/components/schemas/JobConfig'
        filename:
          type: string
    JobConfig:
      type: object
      properties:
        model_size:
          type: string
        subtitles_frequency:
          type: integer
        language:
          type: string
        speaker_detection:
          type: boolean
      required:
        - model_size
        - subtitles_frequency
        - language
        - speaker_detection
    JobRequest:
      type: object
      properties:
        filename:
          type: string
        config:
          $ref: '#/components/schemas/JobConfig'
      required:
        - filename
    JobResponse:
      type: object
      properties:
        id:
          type: string
        info:
          $ref: '#/components/schemas/JobInfo'
        status:
          type: string
          enum:
            - pending
            - running
            - completed
            - failed
        data:
          $ref: '#/components/schemas/TranscriptionData'
      required:
        - id
        - filename
        - config
        - status
        - data
    Word:
      type: object
      properties:
        word:
          type: string
        start:
          type: number
        end:
          type: number
        score:
          type: number
      required:
        - word
        - start
        - end
        - score
    Segment:
      type: object
      properties:
        start:
          type: number
          format: float
        end:
          type: number
          format: float
        text:
          type: string
        words:
          type: array
          items:
            $ref: '#/components/schemas/Word'
      required:
        - start
        - end
        - text
        
    TranscriptionRequest:
      type: object
      properties:
        data:
          $ref: '#/components/schemas/TranscriptionData'
        job_id:
          type: string
        filename:
          type: string

    TranscriptionResponse:
      type: object
      properties:
        id:
          type: string
        data:
          $ref: '#/components/schemas/TranscriptionData'
        job_id:
          type: string
        filename:
          type: string
    TranscriptionData:
      type: object
      properties:
        segments:
          type: array
          items:
            $ref: '#/components/schemas/Segment'
        word_segments:
          type: array
          items:
            $ref: '#/components/schemas/Word'
        language:
          type: string
      required:
        - segments
    FileResponse:
      type: object
      properties:
        id:
          type: string
        filename:
          type: string
        upload_date:
          type: string
          format: date-time
        video_url:
          type: string
        image_url:
          type: string
    ErrorModel:
      type: object
      properties:
        title:
          type: string
        detail:
          type: string
        status:
          type: integer
        type:
          type: string
        
